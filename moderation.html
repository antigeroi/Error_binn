<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Модерация - errorbin</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{background:#000;color:#fff;font-family:Arial}
        .header{background:#111;padding:12px 15px;border-bottom:2px solid red;display:flex;align-items:center}
        .back-btn{background:none;border:none;color:#fff;font-size:18px;margin-right:10px}
        .header h1{color:red;font-size:17px}
        .moderation-container{padding:15px}
        .moderation-header{background:#111;padding:15px;border-radius:8px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center}
        .moderation-header h2{color:red;font-size:16px}
        .moderation-stats{background:red;color:white;padding:6px 12px;border-radius:15px;font-size:12px;font-weight:bold}
        .moderation-paste{background:#111;border-radius:8px;padding:15px;margin-bottom:12px;border-left:3px solid orange}
        .paste-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .paste-lika{color:#0f0;font-weight:bold;font-size:15px}
        .paste-author{color:#888;font-size:12px}
        .paste-preview{color:#ccc;font-size:13px;margin-bottom:15px;max-height:60px;overflow:hidden}
        .moderation-actions{display:flex;gap:8px}
        .action-btn{flex:1;padding:8px;border:none;border-radius:6px;font-size:13px;font-weight:bold}
        .btn-approve{background:#0f0;color:#000}
        .btn-reject{background:red;color:white}
        .btn-view{background:#44f;color:white}
        .no-pastes{text-align:center;padding:50px 20px;color:#666}
        .fame-checkbox{margin-top:10px;font-size:13px}
        .fame-checkbox input{margin-right:5px}
        .message{background:red;color:white;padding:10px;border-radius:5px;margin-bottom:15px;text-align:center;display:none}
        .message.success{background:#0f0;color:#000}
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" onclick="window.history.back()">←</button>
        <h1>Модерация паст</h1>
    </div>

    <div class="moderation-container">
        <div class="message" id="message"></div>
        
        <div class="moderation-header">
            <h2>Пасты на рассмотрении</h2>
            <div class="moderation-stats" id="pendingCount">0</div>
        </div>
        
        <div id="moderationList">
            <!-- Пасты будут здесь -->
        </div>
        
        <div class="no-pastes" id="noPastes" style="display:none">
            <p>Нет паст для модерации</p>
        </div>
    </div>

    <script>
        const DB_KEY = 'errorbin_global_db';
        
        // Проверка админа
        function checkAdmin() {
            const user = JSON.parse(localStorage.getItem('current_user'));
            if (!user) {
                window.location.href = 'login.html';
                return null;
            }
            
            if (!user.isAdmin) {
                alert('Только администратор может заходить в модерацию!');
                window.location.href = 'index.html';
                return null;
            }
            
            return user;
        }
        
        function showMessage(text, type = 'error') {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + (type === 'success' ? 'success' : '');
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 2000);
        }
        
        function getDB() {
            return JSON.parse(localStorage.getItem(DB_KEY));
        }
        
        function saveDB(db) {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
        }
        
        // Загрузка паст на модерацию
        function loadModerationPastes() {
            const admin = checkAdmin();
            if (!admin) return;
            
            const db = getDB();
            const pendingPastes = db.pastes.filter(p => p.status === 'pending');
            
            document.getElementById('pendingCount').textContent = pendingPastes.length;
            
            const list = document.getElementById('moderationList');
            const noPastes = document.getElementById('noPastes');
            
            if (pendingPastes.length === 0) {
                list.innerHTML = '';
                noPastes.style.display = 'block';
                return;
            }
            
            noPastes.style.display = 'none';
            list.innerHTML = '';
            
            pendingPastes.forEach(paste => {
                const pasteEl = document.createElement('div');
                pasteEl.className = 'moderation-paste';
                pasteEl.innerHTML = `
                    <div class="paste-header">
                        <div class="paste-lika">${escapeHtml(paste.lika)}</div>
                        <div class="paste-author">by ${escapeHtml(paste.author)}</div>
                    </div>
                    <div class="paste-preview">
                        ${escapeHtml(paste.validation.substring(0, 120))}${paste.validation.length > 120 ? '...' : ''}
                    </div>
                    <div class="fame-checkbox">
                        <label>
                            <input type="checkbox" id="fame-${paste.id}">
                            Добавить тег #фейм
                        </label>
                    </div>
                    <div class="moderation-actions">
                        <button class="action-btn btn-approve" onclick="moderatePaste('${paste.id}', 'approve')">
                            Одобрить
                        </button>
                        <button class="action-btn btn-reject" onclick="moderatePaste('${paste.id}', 'reject')">
                            Отклонить
                        </button>
                        <button class="action-btn btn-view" onclick="viewPaste('${paste.id}')">
                            Просмотреть
                        </button>
                    </div>
                `;
                list.appendChild(pasteEl);
            });
        }
        
        // Модерация пасты
        function moderatePaste(pasteId, action) {
            const addFame = document.getElementById(`fame-${pasteId}`)?.checked || false;
            
            const db = getDB();
            const pasteIndex = db.pastes.findIndex(p => p.id === pasteId);
            
            if (pasteIndex === -1) {
                showMessage('Паста не найдена');
                return;
            }
            
            if (action === 'approve') {
                db.pastes[pasteIndex].status = 'approved';
                if (addFame) {
                    db.pastes[pasteIndex].tag = '#фейм';
                }
            } else {
                db.pastes[pasteIndex].status = 'rejected';
            }
            
            saveDB(db);
            
            const message = action === 'approve' 
                ? (addFame ? 'Паста одобрена с тегом #фейм!' : 'Паста одобрена!')
                : 'Паста отклонена!';
                
            showMessage(message, 'success');
            
            // Обновление списка
            setTimeout(() => {
                loadModerationPastes();
            }, 1000);
        }
        
        // Просмотр пасты
        function viewPaste(pasteId) {
            const db = getDB();
            const paste = db.pastes.find(p => p.id === pasteId);
            
            if (paste) {
                const content = `
                    Лика: ${paste.lika}
                    Автор: ${paste.author}
                    
                    Валидация:
                    ${paste.validation}
                    
                    Паста:
                    ${paste.content}
                `;
                alert(content);
            }
        }
        
        // Экранирование HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Загрузка при открытии страницы
        document.addEventListener('DOMContentLoaded', () => {
            loadModerationPastes();
        });
    </script>
</body>
</html>
