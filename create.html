<!DOCTYPE html>
<html>
<head>
    <title>Создать пасту</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body{background:#1a1a1a;color:white;font-family:Arial;padding:20px}
        .header{display:flex;align-items:center;margin-bottom:20px}
        .back-btn{color:white;text-decoration:none;font-size:20px;margin-right:10px}
        h1{color:red;margin:0}
        .form-group{margin-bottom:15px}
        input,textarea{width:100%;padding:12px;background:#3a3a3a;border:1px solid #4a4a4a;border-radius:8px;color:white;margin-top:5px}
        textarea{min-height:100px;resize:vertical}
        .btn{width:100%;padding:14px;border:none;border-radius:8px;font-weight:bold;margin-top:10px}
        .btn-submit{background:red;color:white}
        .btn-cancel{background:transparent;border:1px solid #888;color:#888}
        .message{background:red;color:white;padding:10px;border-radius:5px;margin-bottom:15px;display:none}
        .message.success{background:#0f0;color:#000}
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="back-btn">←</a>
        <h1>Создать пасту</h1>
    </div>

    <div class="message" id="message"></div>

    <div class="form-group">
        <label>ЛИКА:</label>
        <input type="text" id="lika" placeholder="Кто сделал" maxlength="100">
    </div>

    <div class="form-group">
        <label>ВАЛИДАЦИЯ:</label>
        <textarea id="validation" placeholder="Цепочка валидации" maxlength="500"></textarea>
    </div>

    <div class="form-group">
        <label>ПАСТА:</label>
        <textarea id="content" placeholder="Информация"></textarea>
    </div>

    <button class="btn btn-submit" onclick="submitPaste()">Создать пасту</button>
    <button class="btn btn-cancel" onclick="window.location='index.html'">Отмена</button>

    <script>
        // НАСТРОЙКИ JSONBIN
        const BIN_ID = '695858f1ae596e708fc0ffea';
        const MASTER_KEY = '$2a$10$ftDuSkomUMvmkGtIeeIAMebzWHBRhLWA.xaosW/.pc8G1ys2HPcxG';
        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        
        function showMessage(text, type = 'error') {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + (type === 'success' ? 'success' : '');
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }
        
        // ЗАГРУЗИТЬ БАЗУ
        async function loadDatabase() {
            try {
                const response = await fetch(JSONBIN_URL + '/latest', {
                    headers: { 'X-Master-Key': MASTER_KEY }
                });
                
                if (!response.ok) throw new Error('Ошибка загрузки');
                const data = await response.json();
                return { db: data.record, version: data.metadata.version };
            } catch (error) {
                console.error('Ошибка:', error);
                return { db: { pastes: [], users: [] }, version: null };
            }
        }
        
        // СОХРАНИТЬ БАЗУ
        async function saveDatabase(db, version) {
            try {
                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': MASTER_KEY,
                        'X-Bin-Versioning': 'false'
                    },
                    body: JSON.stringify(db)
                });
                
                return response.ok;
            } catch (error) {
                console.error('Ошибка сохранения:', error);
                return false;
            }
        }
        
        // ОТПРАВИТЬ ПАСТУ
        async function submitPaste() {
            const lika = document.getElementById('lika').value.trim();
            const validation = document.getElementById('validation').value.trim();
            const content = document.getElementById('content').value.trim();
            
            if (!lika || !validation || !content) {
                showMessage('Заполни все поля!');
                return;
            }
            
            // ЗАГРУЗИТЬ БАЗУ
            const { db, version } = await loadDatabase();
            
            // ДОБАВИТЬ ПАСТУ
            db.pastes.push({
                id: Date.now(),
                lika: lika,
                validation: validation,
                content: content,
                author: 'user_' + Math.random().toString(36).substr(2, 6),
                status: 'pending',
                tag: '',
                date: new Date().toLocaleString()
            });
            
            // СОХРАНИТЬ
            const success = await saveDatabase(db, version);
            
            if (success) {
                showMessage('Паста отправлена на модерацию!', 'success');
                setTimeout(() => window.location.href = 'index.html', 1500);
            } else {
                showMessage('Ошибка при сохранении пасты!');
            }
        }
    </script>
</body>
</html>